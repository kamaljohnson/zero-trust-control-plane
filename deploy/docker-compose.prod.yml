# Production deployment for ZTCP on Digital Ocean
# Includes: PostgreSQL, Observability stack, Backend, Frontend, and Nginx reverse proxy
#
# Usage:
#   docker compose -f docker-compose.prod.yml --env-file .env.prod up -d
#
# For CI/CD (pull from registry): set DOCKER_REGISTRY and IMAGE_TAG, then pull and up.
#   export DOCKER_REGISTRY=ghcr.io/owner/repo  # or docker.io/username
#   export IMAGE_TAG=latest  # or commit SHA
#   docker compose -f docker-compose.prod.yml --env-file .env.prod pull
#   docker compose -f docker-compose.prod.yml --env-file .env.prod up -d
#
# For local build (no registry): omit DOCKER_REGISTRY; images build from Dockerfiles.
#
# Prerequisites:
#   - SSL certificates in ./nginx/ssl/ (run setup-ssl.sh first)
#   - PostgreSQL SSL in ./postgres-ssl/ (run ./scripts/generate-postgres-ssl.sh)
#   - Production .env.prod file configured (DATABASE_URL with sslmode=require)
#   - JWT keys generated

include:
  - postgres.yml
  - observability.yml

services:
  backend:
    image: ${DOCKER_REGISTRY:-local}/ztcp-backend:${IMAGE_TAG:-latest}
    build:
      context: ../backend
      dockerfile: Dockerfile
    container_name: ztcp-backend
    env_file:
      - .env.prod
    # Secrets (DATABASE_URL, JWT keys) come from env_file only to avoid Compose ${VAR} expansion corrupting $ in values.
    environment:
      - GRPC_ADDR=:8080
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://otelcol:4317
      - OTEL_SERVICE_NAME=ztcp-grpc
      - OTEL_EXPORTER_OTLP_INSECURE=false
    volumes:
      # Mount keys so JWT_PRIVATE_KEY=keys/jwt_private.pem and JWT_PUBLIC_KEY=keys/jwt_public.pem resolve in container
      - ./keys:/app/keys:ro
    ports:
      - "127.0.0.1:8080:8080"  # Only expose on localhost for nginx
    depends_on:
      postgres:
        condition: service_healthy
      otelcol:
        condition: service_started
    networks:
      - ztcp-network
    restart: unless-stopped
    healthcheck:
      # Backend exposes gRPC on 8080, not HTTP; use TCP connect check
      # start_period allows time for DB connect, OTLP init, and gRPC server to start
      test: ["CMD-SHELL", "nc -z localhost 8080 || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"

  frontend:
    image: ${DOCKER_REGISTRY:-local}/ztcp-frontend:${IMAGE_TAG:-latest}
    build:
      context: ../frontend
      dockerfile: Dockerfile
    container_name: ztcp-frontend
    env_file:
      - .env.prod
    environment:
      - NODE_ENV=production
      - BACKEND_GRPC_URL=backend:8080
      - NEXT_PUBLIC_DOCS_URL=${NEXT_PUBLIC_DOCS_URL:-}
    ports:
      - "127.0.0.1:3000:3000"  # Only expose on localhost for nginx
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - ztcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"

  nginx:
    image: ${DOCKER_REGISTRY:-local}/ztcp-nginx:${IMAGE_TAG:-latest}
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: ztcp-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./nginx/logs:/var/log/nginx
    depends_on:
      - frontend
      - backend
    networks:
      - ztcp-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "--quiet", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.25"

  # Postgres SSL: override from postgres.yml to enable SSL (certificates from ./postgres-ssl/).
  # Certificates are auto-generated by deploy.sh if missing.
  # The entrypoint wrapper fixes permissions (postgres requires key to be 600 and owned by postgres user).
  postgres:
    volumes:
      - ./postgres-ssl:/etc/postgres-ssl
      - ./scripts/postgres-entrypoint.sh:/usr/local/bin/postgres-entrypoint-wrapper.sh:ro
    entrypoint: ["/usr/local/bin/postgres-entrypoint-wrapper.sh"]
    command: ["postgres", "-c", "ssl=on", "-c", "ssl_cert_file=/etc/postgres-ssl/server.crt", "-c", "ssl_key_file=/etc/postgres-ssl/server.key"]

networks:
  ztcp-network:
    driver: bridge

# Override observability services with production settings
x-observability-overrides: &observability-overrides
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: "0.5"
  restart: unless-stopped

# Override postgres with production settings
x-postgres-overrides: &postgres-overrides
  deploy:
    resources:
      limits:
        memory: 1G
        cpus: "1"
  restart: unless-stopped
  healthcheck:
    test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ztcp}"]
    interval: 10s
    timeout: 5s
    retries: 5
    start_period: 30s
